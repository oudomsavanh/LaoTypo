<!DOCTYPE html>
<html lang="lo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Cache Busting Headers v2.1.0 - Enhanced with authentication and scoring -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡ªÅ‡∫°‡ªà‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫•‡∫≤‡∫ß‡∫à‡∫£‡∫¥‡∫á ‡∫´‡∫º‡∫∑ ‡∫•‡∫≤‡∫ß‡∫≠‡∫µ‡ªà‡∫´‡∫•‡∫µ?</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f8af3c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LaoTypo">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    
    <!-- Fonts and Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao+Looped:wght@400;500;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <style>
        :root {
            --bg-color: #2c2e31;
            --main-color: #f8af3c;
            --sub-color: #646669;
            --text-color: #d1d0c5;
            --error-color: #ca4754;
            --correct-color: #72b483;
            --warning-color: #f59e0b;
        }
        
        /* Global font rules - Montserrat for English, Noto Sans Lao Looped for Lao */
        * {
            font-family: 'Montserrat', 'Noto Sans Lao Looped', sans-serif;
        }
        
        /* Specific rule for elements containing Lao text */
        :lang(lo), 
        [lang="lo"] {
            font-family: 'Noto Sans Lao Looped', 'Montserrat', sans-serif;
        }
        body {
            font-family: 'Montserrat', 'Noto Sans Lao Looped', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            padding-top: 60px; /* Space for fixed nav - responsive */
            padding-bottom: 60px; /* Space for fixed footer - responsive */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @media (min-width: 640px) {
            body {
                padding-top: 80px;
                padding-bottom: 80px;
            }
        }
        nav {
            background-color: #222426;
            border-bottom: 2px solid var(--main-color);
        }
        .nav-link {
            color: var(--sub-color);
            transition: all 0.3s ease-in-out;
            transform-origin: center;
        }
        .nav-link:hover {
            color: var(--text-color);
            transform: scale(1.1) rotate(3deg);
        }
        /* Logo animation */
        #home-btn img {
            transition: transform 0.5s ease;
        }
        #home-btn:hover img {
            transform: scale(1.05);
        }
        .btn-icon {
            background-color: transparent;
            color: var(--sub-color);
            padding: 0.5rem;
            border-radius: 9999px; /* circle */
            transition: all 0.3s ease-in-out;
            transform-origin: center;
        }
        .btn-icon:hover {
            color: var(--text-color);
            background-color: #3e4043;
            transform: scale(1.1) rotate(3deg);
            box-shadow: 0 4px 12px rgba(248, 175, 60, 0.2);
        }
        .btn-icon:active {
            transform: scale(0.95);
        }
        .btn-icon svg {
            width: 1.5rem;
            height: 1.5rem;
            transition: transform 0.3s ease;
        }
        .game-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
            text-align: center;
        }
        @media (min-width: 640px) {
            .game-container {
                padding: 2rem;
            }
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .btn {
            background-color: var(--main-color);
            color: var(--bg-color);
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 1rem;
            font-family: 'Montserrat', 'Noto Sans Lao Looped', sans-serif;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary {
            background-color: var(--main-color);
            color: var(--bg-color);
        }
        .btn-primary:hover {
            background-color: #f8af3c;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .btn-secondary {
            background-color: var(--sub-color);
            color: var(--text-color);
        }
        .word-card {
            background-color: #3e4043;
            border: 2px solid #4a4d50;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Sans Lao Looped', 'Montserrat', sans-serif;
            padding: 1rem;
        }
        
        @media (min-width: 640px) {
            .word-card {
                padding: 1.5rem;
            }
        }
        .word-card:hover {
            border-color: var(--main-color);
            transform: scale(1.02);
        }
        .word-card.focused {
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(248, 175, 60, 0.3);
        }
        .word-card.feedback-correct {
            background-color: var(--correct-color);
            border-color: var(--correct-color);
            color: white;
        }
        .word-card.feedback-incorrect {
            background-color: var(--error-color);
            border-color: var(--error-color);
            color: white;
        }
        .timer-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--correct-color) 0%, var(--main-color) 50%, var(--error-color) 100%);
            border-radius: 1rem;
            transform-origin: left;
            transition: transform 0.1s linear;
        }
        
        /* Life Bar Container with solid color */
        .life-bar-container {
            background: #fbb03b;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(248, 175, 60, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        @media (min-width: 640px) {
            .life-bar-container {
                padding: 1rem 1.5rem;
                margin-bottom: 1.5rem;
            }
        }
        
        /* Removed shimmer effect */
        .life-bar-container::before {
            display: none;
        }
        
        .life-bar-container h2 {
            margin: 0;
        }
        
        /* Shimmer animation removed */
        /* @keyframes shimmer - removed */
        
        .life-hearts-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .life-label {
            color: #000000; /* Black to match background */
            font-weight: 600;
            font-size: 14px;
            margin-right: 8px;
        }
        
        .hearts-container {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        /* Minimal flat heart icon */
        .heart {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (min-width: 640px) {
            .heart {
                width: 28px;
                height: 28px;
            }
        }
        
        .heart svg {
            width: 100%;
            height: 100%;
        }
        
        .heart.active svg path {
            fill: #ff4b4b;
        }
        
        .heart.lost svg path {
            fill: #000000; /* Black heart for lost lives */
        }
        
        /* Subtle Duolingo-style animation when losing a life */
        .heart.losing {
            animation: heartPop 0.4s ease-out;
        }
        
        @keyframes heartPop {
            0% { 
                transform: scale(1);
            }
            30% { 
                transform: scale(1.3);
            }
            60% {
                transform: scale(0.8);
            }
            100% { 
                transform: scale(1);
            }
        }
        
        /* Animation when life value changes */
        .heart.life-change {
            animation: lifeChange 0.5s ease-out;
        }
        
        @keyframes lifeChange {
            0% {
                transform: scale(1) translateY(0);
            }
            25% {
                transform: scale(1.15) translateY(-4px);
            }
            50% {
                transform: scale(0.95) translateY(0);
            }
            100% {
                transform: scale(1) translateY(0);
            }
        }
        
        .motivation-text {
            text-align: center;
            color: #000000; /* Black text */
            font-weight: 600;
            font-style: italic;
            font-size: 0.875rem;
            opacity: 0.9;
            transition: all 0.3s ease;
            text-shadow: none;
            font-family: 'Noto Sans Lao Looped', 'Montserrat', sans-serif;
        }
        
        @media (min-width: 640px) {
            .motivation-text {
                font-size: 0.9rem;
            }
        }
        
        .motivation-text.warning {
            color: #000000; /* Keep black for warning */
            opacity: 1;
            font-weight: 700;
            text-shadow: none;
        }
        
        .motivation-text.critical {
            color: #7f1d1d; /* Dark red for critical */
            opacity: 1;
            font-weight: 800;
            animation: pulse 1s infinite;
            text-shadow: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Custom shake animation for 0 streak */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        
        /* Player name styles - no background or box */
        .player-name {
            background: none !important;
            border: 0 !important;
            box-shadow: none !important;
            padding: 0 !important;
            border-radius: 0 !important;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Meme container styling */
        #meme-container {
            min-height: 200px;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 640px) {
            #meme-container {
                min-height: 150px;
                aspect-ratio: 4 / 3;
            }
        }
        
        /* Enhanced button hover effects */
        .hover\:scale-105:hover {
            transform: scale(1.05);
        }
        
        /* Format button styles */
        .format-btn {
            opacity: 0.7;
            border: 2px solid transparent;
        }
        .format-btn.active {
            opacity: 1;
            border-color: #f8af3c;
            background-color: #3e4043 !important;
        }
        
        /* Rainbow text animation for perfect scores */
        @keyframes rainbow {
            0% { color: #ff0000; }
            17% { color: #ff8800; }
            33% { color: #ffff00; }
            50% { color: #00ff00; }
            67% { color: #0088ff; }
            83% { color: #8800ff; }
            100% { color: #ff0000; }
        }
        
        .animate-rainbow {
            animation: rainbow 3s linear infinite;
        }
        
        /* Custom responsive typography */
        .context-display-custom {
            font-family: 'Noto Sans Lao Looped', 'Montserrat', sans-serif;
            font-weight: bold;
            line-height: 1.3;
        }
        
        .results-header-custom {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        /* Desktop responsive sizes */
        @media (min-width: 768px) {
            .results-header-custom {
                font-size: 2.4rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation from testing.html -->
    <nav class="fixed top-0 left-0 right-0 z-50 p-2 sm:p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="#" id="home-btn" class="flex items-center">
                <img src="LaoTypo-logo-04.png" alt="LaoTypo!" class="h-8 md:h-10 w-auto object-contain">
            </a>
            <div class="flex items-center space-x-2 md:space-x-4">
                <button id="home-nav-btn" class="nav-link btn-icon" title="‡ªú‡ªâ‡∫≤‡∫´‡∫º‡∫±‡∫Å">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                    </svg>
                </button>
                <button id="leaderboard-nav-btn" class="nav-link btn-icon" title="‡∫Å‡∫∞‡∫î‡∫≤‡∫ô‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M5 7C5 5.89543 5.89543 5 7 5H17C18.1046 5 19 5.89543 19 7V11C19 12.8638 17.7252 14.4299 16 14.874V17H13L12 20L11 17H8V14.874C6.27477 14.4299 5 12.8638 5 11V7Z" />
                        <path d="M8 8H16" />
                        <path d="M12 3V5" />
                        <path d="M8 5C8 5 6.5 3 5 3" />
                        <path d="M16 5C16 5 17.5 3 19 3" />
                        <path d="M9 20H15" />
                        <path d="M12 17V20" />
                    </svg>
                </button>
                <button id="open-settings-btn" class="nav-link btn-icon" title="‚öôÔ∏è ‡∫ï‡∫±‡ªâ‡∫á‡∫Ñ‡ªà‡∫≤">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
                <button id="account-nav-btn" class="nav-link btn-icon" title="‡∫ö‡∫±‡∫ô‡∫ä‡∫µ/‡∫™‡∫∞‡∫ñ‡∫¥‡∫ï‡∫¥">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </div>
        </div>
    </nav>

    <div class="game-container">
        <div class="w-full">
            <!-- Game Screen -->
            <div id="game-screen" class="screen active">
                <!-- Word Loading Status -->
                <div id="word-loading-status" class="text-center mb-4 text-main-color text-sm sm:text-base">
                    ‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö‡∫à‡∫≤‡∫Å Google Sheets...
                </div>
                    <!-- Player Name Display without background -->
                    <div class="text-center mb-3 sm:mb-4">
                        <div class="inline-flex items-center gap-2 player-name">
                            <svg width="20" height="20" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M128 28C70.562 28 24 74.562 24 132C24 189.438 70.562 236 128 236C185.438 236 232 189.438 232 132C232 74.562 185.438 28 128 28ZM128 44C176.604 44 216 83.396 216 132C216 156.48 206.792 178.712 191.636 195.364C186.768 182.968 178.572 172.504 168.02 165.012C175.652 157.036 180 146.248 180 134.5C180 110.804 159.196 90 135.5 90H120.5C96.804 90 76 110.804 76 134.5C76 146.248 80.348 157.036 87.98 165.012C77.428 172.504 69.232 182.968 64.364 195.364C49.208 178.712 40 156.48 40 132C40 83.396 79.396 44 128 44ZM120.5 106H135.5C150.412 106 164 119.588 164 134.5C164 149.412 150.412 163 135.5 163H120.5C105.588 163 92 149.412 92 134.5C92 119.588 105.588 106 120.5 106ZM78.692 203.872C82.66 187.616 96.94 175 114 175H142C159.06 175 173.34 187.616 177.308 203.872C161.816 215.156 145.704 220 128 220C110.296 220 94.184 215.156 78.692 203.872Z" fill="#fbb03b"/>
                            </svg>
                            <span style="color: #d1d0c5; font-weight: 600; font-size: 14px; font-family: 'Noto Sans Lao Looped', 'Montserrat', sans-serif;" class="sm:text-base">‡∫ó‡ªà‡∫≤‡∫ô‡∫ú‡∫π‡ªâ‡∫´‡∫º‡∫¥‡ªâ‡∫ô: <span id="game-player-name" style="font-family: 'Montserrat', 'Noto Sans Lao Looped', sans-serif;"></span></span>
                        </div>
                    </div>
                <!-- Redesigned Life Bar with Enhanced Visual Design -->
                <div class="life-bar-container mb-4">
                    <div class="motivation-text text-sm sm:text-base" id="motivation-text">‡∫ó‡ªà‡∫≤‡∫ô‡∫°‡∫µ‡ªÇ‡∫≠‡∫Å‡∫≤‡∫î‡∫ï‡∫≠‡∫ö‡∫ú‡∫¥‡∫î‡∫û‡∫Ω‡∫á‡ªÅ‡∫ï‡ªà 3 ‡∫Ñ‡∫±‡ªâ‡∫á!</div>
                    <div class="life-hearts-row">
                        <div class="hearts-container" id="hearts-container">
                            <span class="heart active">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </span>
                            <span class="heart active">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </span>
                            <span class="heart active">
                                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                                </svg>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mb-4 sm:mb-6 text-base sm:text-xl">
                    <div class="text-sub-color">‡∫ï‡∫≠‡∫ö‡∫ñ‡∫∑‡∫Å: <span id="current-streak" class="text-text-color font-bold">0</span> / <span id="level-progress" class="text-main-color">15</span></div>
                    <div class="text-sub-color">‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫ó‡∫µ‡ªà‡∫î‡∫µ‡∫ó‡∫µ‡ªà‡∫™‡∫∏‡∫î: <span id="best-streak" class="text-text-color font-bold">0</span></div>
                </div>
                
                <div class="text-center mb-3 sm:mb-4">
                    <span id="game-settings-display" class="text-xs sm:text-sm text-main-color">‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö: <span id="difficulty-display" class="font-bold"></span> | ‡∫à‡∫≥‡∫Å‡∫±‡∫î‡ªÄ‡∫ß‡∫•‡∫≤: <span id="timer-status">‡∫õ‡∫¥‡∫î</span></span>
                </div>
                <div id="timer-container" class="h-2 mb-4 sm:mb-6">
                    <div id="timer-bar" class="timer-bar"></div>
                </div>
                
                <!-- Context display area for showing word from Google Sheets Column A -->
                <div class="mb-4 sm:mb-6 text-center">
                    <h3 class="text-lg sm:text-xl text-sub-color mb-2">‡ªÄ‡∫•‡∫∂‡∫≠‡∫Å‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö‡∫ó‡∫µ‡ªà‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á‡ªÉ‡∫™‡ªà‡∫ö‡ªà‡∫≠‡∫ô‡∫´‡∫ß‡ªà‡∫≤‡∫á:</h3>
                    <div id="context-display" class="context-display-custom text-text-color bg-[#3e4043] rounded-lg py-3 sm:py-4 px-4 sm:px-6 min-h-[80px] sm:min-h-[100px] flex items-center justify-center text-base sm:text-2xl"></div>
                </div>
                
                <div id="word-area" class="grid grid-cols-2 gap-3 sm:gap-4 md:gap-8 mb-6 sm:mb-8">
                    <div id="word-card-left" class="word-card p-4 sm:p-6 text-base sm:text-xl md:text-2xl min-h-[80px] sm:min-h-[100px]"></div>
                    <div id="word-card-right" class="word-card p-4 sm:p-6 text-base sm:text-xl md:text-2xl min-h-[80px] sm:min-h-[100px]"></div>
                </div>
            </div>

            <!-- Results Screen -->
            <div id="results-screen" class="screen pb-20">
                <div class="space-y-4 sm:space-y-6 max-w-2xl mx-auto px-4">
                    <h2 class="results-header-custom text-main-color animate-pulse">‡ªÄ‡∫Å‡∫°‡∫à‡∫ª‡∫ö</h2>
                    
                    <!-- Meme Image Container -->
                    <div id="meme-container" class="w-full max-w-xs sm:max-w-md mx-auto rounded-lg shadow-lg overflow-hidden bg-gray-800">
                        <!-- Meme image will be inserted here dynamically -->
                    </div>
                    
                    <!-- Stats Container with Card Design -->
                    <div class="bg-gray-800/50 backdrop-blur rounded-xl p-3 sm:p-6 shadow-2xl border border-gray-700">
                        <div class="grid grid-cols-3 gap-2 sm:gap-4 text-center">
                            <div class="bg-gray-900/50 rounded-lg p-2 sm:p-4">
                                <p class="text-gray-400 text-xs sm:text-sm mb-1">‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫´‡∫º‡ªâ‡∫≤‡∫™‡∫∏‡∫î</p>
                                <p class="text-xl sm:text-3xl font-bold text-white" id="final-streak">0</p>
                            </div>
                            <div class="bg-gray-900/50 rounded-lg p-2 sm:p-4">
                                <p class="text-gray-400 text-xs sm:text-sm mb-1">‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫ó‡∫µ‡ªà‡∫î‡∫µ‡∫ó‡∫µ‡ªà‡∫™‡∫∏‡∫î</p>
                                <p class="text-xl sm:text-3xl font-bold text-yellow-400" id="results-best-streak">0</p>
                            </div>
                            <div class="bg-gray-900/50 rounded-lg p-2 sm:p-4">
                                <p class="text-gray-400 text-xs sm:text-sm mb-1">‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á</p>
                                <p class="text-xl sm:text-3xl font-bold text-green-400" id="accuracy-stat">0%</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Evaluation Result with Enhanced Styling -->
                    <div class="text-center px-4">
                        <p class="text-gray-400 text-base sm:text-lg mb-2">‡∫ú‡∫ª‡∫ô‡∫Å‡∫≤‡∫ô‡∫õ‡∫∞‡ªÄ‡∫°‡∫µ‡∫ô:</p>
                        <p id="evaluation-result" class="text-lg sm:text-2xl font-bold text-center mt-2 sm:mt-4"></p>
                    </div>
                    
                    <!-- Share Image Section -->
                    <div class="bg-gray-800/50 backdrop-blur rounded-xl p-3 sm:p-6 shadow-2xl border border-gray-700 mb-4">
                        <h3 class="text-lg sm:text-xl font-bold text-main-color mb-4">‡ªÅ‡∫ö‡ªà‡∫á‡∫õ‡∫±‡∫ô‡∫ú‡∫ª‡∫ô‡∫Ç‡∫≠‡∫á‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤!</h3>
                        
                        <!-- Canvas for shareable image -->
                        <canvas id="share-canvas" class="hidden"></canvas>
                        
                        <!-- Preview of shareable image -->
                        <div id="share-preview-container" class="mb-4 hidden">
                            <img id="share-preview" class="w-full max-w-md mx-auto rounded-lg shadow-lg" alt="Share preview">
                        </div>
                        
                        <!-- Format selector -->
                        <div class="flex justify-center gap-2 mb-3">
                            <button id="format-square" class="format-btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg text-sm transition duration-300 active">
                                ‡∫™‡∫µ‡ªà‡∫´‡∫º‡ªà‡∫Ω‡∫° (1:1)
                            </button>
                            <button id="format-landscape" class="format-btn bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg text-sm transition duration-300">
                                ‡ªÅ‡∫ô‡∫ß‡∫ô‡∫≠‡∫ô (16:9)
                            </button>
                        </div>
                        
                        <!-- Share buttons -->
                        <div class="flex flex-wrap justify-center gap-3">
                            <button id="generate-share-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold transition duration-300 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                ‡∫™‡ªâ‡∫≤‡∫á‡∫Æ‡∫π‡∫ö‡ªÅ‡∫ö‡ªà‡∫á‡∫õ‡∫±‡∫ô
                            </button>
                            
                            <button id="native-share-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold transition duration-300 flex items-center gap-2 hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m9.032 4.026a9.001 9.001 0 01-7.432 0m9.032-4.026A9.001 9.001 0 0112 3c-4.474 0-8.268 3.12-9.032 7.326m0 0A9.001 9.001 0 0012 21c4.474 0 8.268-3.12 9.032-7.326M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                ‡ªÅ‡∫ö‡ªà‡∫á‡∫õ‡∫±‡∫ô
                            </button>
                            
                            <button id="download-share-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold transition duration-300 flex items-center gap-2 hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                ‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫•‡∫î‡∫Æ‡∫π‡∫ö
                            </button>
                            
                            <button id="copy-share-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-bold transition duration-300 flex items-center gap-2 hidden">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                ‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡∫Æ‡∫π‡∫ö
                            </button>
                        </div>
                        
                        <!-- Copy status message -->
                        <div id="copy-status" class="mt-3 text-sm text-green-400 hidden">
                            ‚úÖ ‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡∫Æ‡∫π‡∫ö‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î‡ªÅ‡∫•‡ªâ‡∫ß!
                        </div>
                    </div>
                    
                    <!-- Action Buttons with Meme Style -->
                    <div class="flex flex-col items-center space-y-3 px-4">
                        <button id="restart-game-btn" class="w-full sm:w-auto bg-[#f8af3c] text-[#2c2e31] text-lg sm:text-xl px-4 sm:px-6 py-2 sm:py-3 rounded-lg hover:scale-105 transition duration-300 font-bold shadow-lg">
                            üîÅ ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫≠‡∫µ‡∫Å‡∫Ñ‡∫±‡ªâ‡∫á üîÅ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Level Transition Interstitial Modal -->
            <div id="level-transition-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black bg-opacity-75">
                <div class="bg-gray-800 rounded-xl p-6 sm:p-8 max-w-md w-full shadow-2xl border-2 border-[#f8af3c]">
                    <div class="text-center">
                        <!-- Success Icon -->
                        <div class="text-6xl sm:text-8xl mb-4" id="level-icon">üéâ</div>
                        
                        <!-- Level Completion Message -->
                        <h2 class="text-2xl sm:text-3xl font-bold text-[#f8af3c] mb-4" id="level-message">
                            ‡∫ó‡ªà‡∫≤‡∫ô‡∫ú‡ªà‡∫≤‡∫ô‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫á‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß!
                        </h2>
                        
                        <!-- Progress Stats -->
                        <div class="bg-gray-900/50 rounded-lg p-4 mb-6">
                            <p class="text-gray-400 text-sm mb-2">‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫ô‡∫µ‡ªâ</p>
                            <p class="text-2xl font-bold text-white"><span id="level-score">15</span>/15</p>
                        </div>
                        
                        <!-- Question -->
                        <p class="text-lg sm:text-xl text-gray-300 mb-6" id="level-question">
                            ‡∫™‡∫∑‡∫ö‡∫ï‡ªç‡ªà‡ªÑ‡∫õ‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á‡∫ö‡ªç?
                        </p>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                            <button id="continue-next-level" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition duration-300 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ‡ªÅ‡∫°‡ªà‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß, ‡∫™‡∫∑‡∫ö‡∫ï‡ªç‡ªà!
                            </button>
                            <button id="replay-current-level" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-bold transition duration-300 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫ô‡∫µ‡ªâ‡∫ï‡ªç‡ªà
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStreak = 0;
        let bestStreak = 0;
        let currentWordIndex = 0;
        let wordPairs = [];
        let correctAnswers = 0;
        let totalAnswers = 0;
        let timerInterval;
        let timerEnabled = false;
        let timeLimit = 5000; // 5 seconds
        let currentTimeout;
        let playerName = '';
        let selectedDifficulty = 'easy';
        let isKeyboardEnabled = true;
        let gameActive = false;
        let synth = null;
        let soundEnabled = true;
        let selectedLeftCard = false;
        let selectedRightCard = false;
        
        // v2.0.0: Progressive Difficulty System
        let playerLives = 3;
        let currentLevel = 0; // 0: easy, 1: medium, 2: hard
        let levelProgress = 0;
        const levelThresholds = [15, 15, 15]; // Words needed to complete each level
        const levelNames = ['‡∫á‡ªà‡∫≤‡∫ç', '‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á', '‡∫ç‡∫≤‡∫Å'];
        const levelColors = ['#4ade80', '#fbbf24', '#ef4444'];
        const levelScores = { easy: 0, medium: 0, hard: 0 };
        
        // Google Sheets CSV URL (same as original gameplay.html)
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1jhdIOg9aqy7Jb28pqnz9I5F23uQ8HYyABvvMxqSzGr0/export?format=csv&gid=0';
        
        // DOM elements
        const gameScreen = document.getElementById('game-screen');
        const resultsScreen = document.getElementById('results-screen');
        const currentStreakEl = document.getElementById('current-streak');
        const bestStreakEl = document.getElementById('best-streak');
        const finalStreakEl = document.getElementById('final-streak');
        const resultsBestStreakEl = document.getElementById('results-best-streak');
        const accuracyStatEl = document.getElementById('accuracy-stat');
        const evaluationResultEl = document.getElementById('evaluation-result');
        const contextDisplay = document.getElementById('context-display');
        const wordCardLeft = document.getElementById('word-card-left');
        const wordCardRight = document.getElementById('word-card-right');
        const timerBar = document.getElementById('timer-bar');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const gamePlayerNameEl = document.getElementById('game-player-name');
        const gameSettingsDisplay = document.getElementById('game-settings-display');
        const difficultyDisplay = document.getElementById('difficulty-display');
        const wordLoadingStatus = document.getElementById('word-loading-status');
        
        // Life system elements
        const heartsContainer = document.getElementById('hearts-container');
        const motivationText = document.getElementById('motivation-text');

        // Initialize game
        async function initializeGame() {
            loadGameSettings();
            updateUI();
            await loadWordsFromGoogleSheets();
            setupEventListeners();
            setupNavigationHandlers();
            initializeSounds();
            showNewWords();
        }

        // Load game settings from localStorage
        function loadGameSettings() {
            const storedSettings = localStorage.getItem('gameSettings');
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                selectedDifficulty = settings.difficulty || 'easy';
                timerEnabled = settings.timerEnabled || false;
                soundEnabled = settings.soundEnabled !== false;
            }
            
            // Get player name from URL parameters first, then fallback to localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const urlPlayerName = urlParams.get('player');
            if (urlPlayerName) {
                playerName = decodeURIComponent(urlPlayerName);
                // Store in localStorage for consistency
                localStorage.setItem('displayName', playerName);
            } else {
                playerName = localStorage.getItem('displayName') || '‡ªÅ‡∫Ç‡∫Å';
            }
            
            bestStreak = parseInt(localStorage.getItem('bestStreak') || '0');
            
            // Update UI with settings
            gamePlayerNameEl.textContent = playerName;
            const timerText = timerEnabled ? '‡ªÄ‡∫õ‡∫µ‡∫î' : '‡∫õ‡∫¥‡∫î';
            const timerStatusEl = document.getElementById('timer-status');
            if (timerStatusEl) {
                timerStatusEl.textContent = timerText;
            }
            updateDifficultyDisplay();
        }

        // Update difficulty display with color
        function updateDifficultyDisplay() {
            difficultyDisplay.textContent = levelNames[currentLevel];
            difficultyDisplay.style.color = levelColors[currentLevel];
        }

        // Load words from Google Sheets CSV
        async function loadWordsFromGoogleSheets() {
            try {
                wordLoadingStatus.textContent = '‡∫Å‡∫≥‡∫•‡∫±‡∫á‡ªÇ‡∫´‡∫º‡∫î‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö‡∫à‡∫≤‡∫Å Google Sheets...';
                wordLoadingStatus.style.color = 'var(--main-color)';
                
                const response = await fetch(GOOGLE_SHEETS_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                
                // Parse CSV data: A=context, B=correct, C=wrong, D=difficulty (optional)
                wordPairs = lines
                    .slice(1) // Skip header row
                    .map(line => {
                        const columns = line.split(',').map(col => col.replace(/"/g, '').trim());
                        if (columns.length >= 3 && columns[0] && columns[1] && columns[2]) {
                            return {
                                context: columns[0],    // Column A - context to display
                                correct: columns[1],    // Column B - correct answer
                                incorrect: columns[2],  // Column C - incorrect answer
                                difficulty: columns[3] ? parseInt(columns[3]) : 1  // Column D - difficulty (optional)
                            };
                        }
                        return null;
                    })
                    .filter(item => item !== null); // Remove invalid entries
                
                console.log("Word list loaded from Google Sheets:", wordPairs.length, "entries");
                console.log("Sample entries:", wordPairs.slice(0, 3));
                
                if (wordPairs.length === 0) {
                    throw new Error("No valid entries found in the spreadsheet");
                }
                
                wordLoadingStatus.textContent = `‡ªÇ‡∫´‡∫º‡∫î‡∫™‡∫≥‡ªÄ‡∫•‡∫±‡∫î! ‡∫°‡∫µ ${wordPairs.length} ‡∫Ñ‡∫≥‡∫™‡∫±‡∫ö`;
                wordLoadingStatus.style.color = 'var(--correct-color)';
                
                // Hide loading status after successful load
                setTimeout(() => {
                    wordLoadingStatus.style.display = 'none';
                }, 2000);
                
                // Shuffle words
                wordPairs = shuffleArray(wordPairs);
                
            } catch (error) {
                console.error("Error loading word list from Google Sheets:", error);
                console.log("Error details:", error.message);
                console.log("Fetch URL:", GOOGLE_SHEETS_URL);
                
                wordLoadingStatus.textContent = '‡ªÇ‡∫´‡∫º‡∫î‡∫ú‡∫¥‡∫î‡∫û‡∫≤‡∫î! ‡ªÉ‡∫ä‡ªâ‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô‡∫ó‡∫ª‡∫î‡∫™‡≠≠‡∫ö';
                wordLoadingStatus.style.color = 'var(--warning-color)';
                
                // Fallback to default words
                wordPairs = getDefaultWords();
                
                // Hide loading status after fallback load
                setTimeout(() => {
                    wordLoadingStatus.style.display = 'none';
                }, 3000);
            }
        }

        // Get default words as fallback
        function getDefaultWords() {
            return [
                { context: '‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ', correct: '‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ', incorrect: '‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ‡∫µ', difficulty: 1 },
                { context: '‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫à', correct: '‡∫Ç‡∫≠‡∫ö‡ªÉ‡∫à', incorrect: '‡∫Ç‡∫≠‡∫ö‡∫à‡∫±‡∫ç', difficulty: 1 },
                { context: '‡∫•‡∫≤‡∫ß', correct: '‡∫•‡∫≤‡∫ß', incorrect: '‡∫•‡∫≤‡∫ç', difficulty: 1 },
                { context: "‡∫Ñ‡∫ª‡∫ô‡∫ó‡∫µ‡ªà‡∫Ç‡∫±‡∫ö‡∫•‡∫ª‡∫î", correct: "‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö", incorrect: "‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫±‡∫ö‡∫£‡ªå", difficulty: 1 },
                { context: "‡∫ú‡∫π‡ªâ‡∫ó‡∫µ‡ªà‡∫°‡∫±‡∫Å‡ªÄ‡∫ß‡∫ª‡ªâ‡∫≤", correct: "‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫µ‡ªâ‡∫Ñ‡∫∏‡∫ç", incorrect: "‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫µ‡∫Ñ‡∫∏‡ªâ‡∫ç", difficulty: 1 },
                { context: "‡∫ú‡∫π‡ªâ‡∫ó‡∫µ‡ªà‡∫°‡∫±‡∫Å‡∫´‡∫º‡∫≠‡∫Å‡∫•‡∫ß‡∫á", correct: "‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫µ‡ªâ‡∫ï‡∫ª‡∫ß‡∫∞", incorrect: "‡∫Ñ‡∫ª‡∫ô‡∫Ç‡∫µ‡∫ï‡∫ª‡ªâ‡∫ß‡∫∞", difficulty: 1 },
                { context: '‡∫û‡∫≤‡∫™‡∫≤‡∫•‡∫≤‡∫ß', correct: '‡∫û‡∫≤‡∫™‡∫≤‡∫•‡∫≤‡∫ß', incorrect: '‡∫û‡∫≤‡∫™‡∫≤‡∫•‡∫≤‡∫ç', difficulty: 2 },
                { context: '‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫Ω‡∫ô', correct: '‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫Ω‡∫ô', incorrect: '‡ªÇ‡∫Æ‡∫á‡∫Æ‡∫¥‡∫Ω‡∫ô', difficulty: 2 },
                { context: '‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î‡∫•‡∫≤‡∫ß', correct: '‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î‡∫•‡∫≤‡∫ß', incorrect: '‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î‡∫•‡∫≤‡∫ç', difficulty: 2 },
                { context: '‡∫Ñ‡∫≠‡∫°‡∫û‡∫¥‡∫ß‡ªÄ‡∫ï‡∫µ', correct: '‡∫Ñ‡∫≠‡∫°‡∫û‡∫¥‡∫ß‡ªÄ‡∫ï‡∫µ', incorrect: '‡∫Ñ‡∫≠‡∫°‡∫û‡∫¥‡∫ç‡ªÄ‡∫ï‡∫µ', difficulty: 3 },
                { context: '‡∫ß‡∫¥‡∫ó‡∫∞‡∫ç‡∫≤‡∫™‡∫≤‡∫î', correct: '‡∫ß‡∫¥‡∫ó‡∫∞‡∫ç‡∫≤‡∫™‡∫≤‡∫î', incorrect: '‡∫ß‡∫¥‡∫ó‡∫∞‡∫ç‡∫≤‡∫™‡∫≤‡∫ç', difficulty: 3 },
                { context: '‡ªÄ‡∫ï‡∫±‡∫Å‡ªÇ‡∫ô‡ªÇ‡∫•‡∫ä‡∫µ', correct: '‡ªÄ‡∫ï‡∫±‡∫Å‡ªÇ‡∫ô‡ªÇ‡∫•‡∫ä‡∫µ', incorrect: '‡ªÄ‡∫ï‡∫±‡∫Å‡ªÇ‡∫ô‡ªÇ‡∫•‡∫ä‡∫¥', difficulty: 3 }
            ];
        }

        // Shuffle array
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // Show new words
        function showNewWords() {
            if (currentWordIndex >= wordPairs.length) {
                currentWordIndex = 0;
                wordPairs = shuffleArray(wordPairs);
            }

            const wordPair = wordPairs[currentWordIndex];
            contextDisplay.textContent = wordPair.context;
            
            const options = [wordPair.correct, wordPair.incorrect];
            const shuffled = Math.random() > 0.5 ? options : options.reverse();
            
            wordCardLeft.textContent = shuffled[0];
            wordCardRight.textContent = shuffled[1];
            
            // Reset card states
            wordCardLeft.classList.remove('feedback-correct', 'feedback-incorrect', 'focused');
            wordCardRight.classList.remove('feedback-correct', 'feedback-incorrect', 'focused');
            selectedLeftCard = false;
            selectedRightCard = false;
            
            currentWordIndex++;
            gameActive = true;
            
            if (timerEnabled) {
                startTimer();
            }
        }

        // Check answer
        function checkAnswer(selectedWord) {
            if (!gameActive) return;
            
            gameActive = false;
            clearTimeout(currentTimeout);
            
            const wordPair = wordPairs[currentWordIndex - 1];
            const isCorrect = selectedWord === wordPair.correct;
            
            totalAnswers++;
            
            // Visual feedback
            const selectedCard = selectedWord === wordCardLeft.textContent ? wordCardLeft : wordCardRight;
            const otherCard = selectedCard === wordCardLeft ? wordCardRight : wordCardLeft;
            
            if (isCorrect) {
                correctAnswers++;
                currentStreak++;
                levelProgress++;
                levelScores[levelNames[currentLevel].toLowerCase()]++;
                selectedCard.classList.add('feedback-correct');
                playSound('correct');
                
                // Check level progression
                if (levelProgress >= levelThresholds[currentLevel]) {
                    // Show level transition modal
                    showLevelTransitionModal();
                }
                
                // Update UI immediately
                updateUI();
            } else {
                selectedCard.classList.add('feedback-incorrect');
                otherCard.classList.add('feedback-correct');
                playSound('incorrect');
                loseLife();
            }
            
            if (playerLives > 0) {
                setTimeout(() => {
                    showNewWords();
                }, 1500);
            }
        }

        // Update level display
        function updateLevelDisplay() {
            // Update the progress display in the score section
            const progressEl = document.getElementById('level-progress');
            if (progressEl) {
                progressEl.textContent = levelThresholds[currentLevel];
            }
            
            // Update difficulty display span
            updateDifficultyDisplay();
            
            // Motivation text no longer shows score/lives
            updateMotivationalText();
        }

        // Update life display with new motivational text
        function updateLifeDisplay() {
            const hearts = heartsContainer.querySelectorAll('.heart');
            
            hearts.forEach((heart, index) => {
                // Add life-change animation to active hearts
                if (index < playerLives) {
                    heart.classList.remove('lost');
                    heart.classList.add('active');
                    // Add subtle animation when life changes
                    heart.classList.add('life-change');
                    setTimeout(() => {
                        heart.classList.remove('life-change');
                    }, 500);
                } else {
                    heart.classList.add('lost');
                    heart.classList.remove('active');
                }
            });
            
            // Update motivational text based on lives
            updateMotivationalText();
        }

        function updateMotivationalText() {
            motivationText.classList.remove('warning', 'critical');
            
            switch(playerLives) {
                case 3:
                    motivationText.textContent = '‡∫ó‡ªà‡∫≤‡∫ô‡∫°‡∫µ‡ªÇ‡∫≠‡∫Å‡∫≤‡∫î‡∫ï‡∫≠‡∫ö‡∫ú‡∫¥‡∫î‡∫û‡∫Ω‡∫á‡ªÅ‡∫ï‡ªà 3 ‡∫Ñ‡∫±‡ªâ‡∫á!';
                    break;
                case 2:
                    motivationText.textContent = '‡ªÄ‡∫´‡∫º‡∫∑‡∫≠‡ªÇ‡∫≠‡∫Å‡∫≤‡∫î‡∫≠‡∫µ‡∫Å 2 ‡∫Ñ‡∫±‡ªâ‡∫á';
                    motivationText.classList.add('warning');
                    break;
                case 1:
                    motivationText.textContent = '‡ªÇ‡∫≠‡∫Å‡∫≤‡∫î‡∫™‡∫∏‡∫î‡∫ó‡ªâ‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß!!';
                    motivationText.classList.add('critical');
                    break;
                case 0:
                    motivationText.textContent = '‡ªÄ‡∫Å‡∫°‡∫à‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß!';
                    motivationText.classList.add('critical');
                    break;
            }
        }

        function updateMotivationTextColor() {
            // This function is now handled by updateMotivationalText
        }

        function loseLife() {
            if (playerLives > 0) {
                playerLives--;
                
                const hearts = heartsContainer.querySelectorAll('.heart');
                const heartToBreak = hearts[playerLives];
                
                // Add losing animation
                heartToBreak.classList.add('losing');
                
                setTimeout(() => {
                    heartToBreak.classList.remove('losing');
                    heartToBreak.classList.remove('active');
                    heartToBreak.classList.add('lost');
                    
                    // Update motivational text
                    updateMotivationalText();
                    
                    if (playerLives === 0) {
                        gameOver();
                    }
                }, 400);
            }
        }

        function gameOver() {
            // When player runs out of lives, just call endGame
            endGame();
        }

        // Timer functions
        function startTimer() {
            if (!timerEnabled) return;
            
            clearTimeout(currentTimeout);
            timerBar.style.transform = 'scaleX(1)';
            
            const startTime = Date.now();
            
            const updateTimer = () => {
                const elapsed = Date.now() - startTime;
                const progress = 1 - (elapsed / timeLimit);
                
                if (progress <= 0) {
                    timerBar.style.transform = 'scaleX(0)';
                    if (gameActive) {
                        gameActive = false;
                        playSound('timeout');
                        loseLife();
                        
                        if (playerLives > 0) {
                            setTimeout(() => {
                                showNewWords();
                            }, 1500);
                        }
                    }
                } else {
                    timerBar.style.transform = `scaleX(${progress})`;
                    currentTimeout = requestAnimationFrame(updateTimer);
                }
            };
            
            currentTimeout = requestAnimationFrame(updateTimer);
        }

        // Update UI
        function updateUI() {
            currentStreakEl.textContent = currentStreak;
            bestStreakEl.textContent = bestStreak;
            
            if (currentStreak > bestStreak) {
                bestStreak = currentStreak;
                localStorage.setItem('bestStreak', bestStreak);
            }
        }

        // End game (general purpose)
        function endGame() {
            gameActive = false;
            clearTimeout(currentTimeout);
            
            // Calculate final percentage score
            const accuracy = totalAnswers > 0 ? ((correctAnswers / totalAnswers) * 100) : 0;
            const accuracyRounded = accuracy.toFixed(1);
            
            // Update stats displays
            document.getElementById('final-streak').textContent = currentStreak;
            document.getElementById('results-best-streak').textContent = bestStreak;
            document.getElementById('accuracy-stat').textContent = `${accuracyRounded}%`;
            
            // Get meme container and evaluation element
            const memeContainer = document.getElementById('meme-container');
            const evaluationEl = document.getElementById('evaluation-result');
            
            // Clear previous classes
            evaluationEl.className = 'text-xl sm:text-3xl font-bold text-center mt-2 sm:mt-4';
            
            // Determine evaluation tier based on percentage only
            let evaluation = '';
            let memeContent = '';
            
            if (accuracy >= 90) {
                // 90-100%: Born to be Lao
                evaluation = '‡∫ä‡∫≤‡∫î‡∫Å‡ªà‡∫≠‡∫ô‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡ªÄ‡∫Å‡∫µ‡∫î‡ªÄ‡∫õ‡∫±‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫•‡∫≤‡∫ß ‡∫ä‡∫≤‡∫î‡∫ô‡∫µ‡ªâ‡∫Å‡ªç‡ªÄ‡∫ä‡∫±‡ªà‡∫ô‡∫Å‡∫±‡∫ô';
                evaluationEl.classList.add('text-yellow-400', 'animate-bounce');
                memeContent = `
                    <div class="flex items-center justify-center h-full bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 relative overflow-hidden p-4">
                        <div class="text-center z-10">
                            <div class="text-7xl sm:text-9xl mb-2 sm:mb-4 animate-pulse">üèÜ</div>
                            <p class="text-xl sm:text-3xl text-white font-bold">BORN TO BE LAO!</p>
                            <p class="text-base sm:text-xl text-gray-100">${accuracyRounded}% - Legendary!</p>
                        </div>
                        <div class="absolute inset-0 opacity-40">
                            <div class="animate-spin text-6xl sm:text-8xl absolute top-4 left-4" style="animation-duration: 3s;">‚≠ê</div>
                            <div class="animate-spin text-6xl sm:text-8xl absolute top-4 right-4" style="animation-duration: 4s;">üåü</div>
                            <div class="animate-spin text-6xl sm:text-8xl absolute bottom-4 left-4" style="animation-duration: 2s;">‚ú®</div>
                            <div class="animate-spin text-6xl sm:text-8xl absolute bottom-4 right-4" style="animation-duration: 5s;">üí´</div>
                        </div>
                    </div>
                `;
            } else if (accuracy >= 70) {
                // 70-89%: 75% True Lao Child
                evaluation = '‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡ªÅ‡∫°‡ªà‡∫ô‡∫•‡∫π‡∫Å‡∫ä‡∫≠‡∫î‡∫•‡∫≤‡∫ß 75%';
                evaluationEl.classList.add('text-green-400', 'animate-pulse');
                memeContent = `
                    <div class="flex items-center justify-center h-full bg-gradient-to-br from-green-500 to-blue-600 p-4">
                        <div class="text-center">
                            <div class="text-6xl sm:text-8xl mb-2 sm:mb-4">üéâ</div>
                            <p class="text-lg sm:text-2xl text-white font-bold">TRUE LAO CHILD!</p>
                            <p class="text-sm sm:text-lg text-gray-200">${accuracyRounded}% - Impressive!</p>
                            <div class="mt-2 text-4xl sm:text-6xl">üéäüåü</div>
                        </div>
                    </div>
                `;
            } else if (accuracy >= 40) {
                // 40-69%: Born in Laos but grew up abroad
                evaluation = '‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡ªÄ‡∫Å‡∫µ‡∫î‡∫¢‡∫π‡ªà‡∫•‡∫≤‡∫ß ‡ªÅ‡∫ï‡ªà‡ªÑ‡∫õ‡ªÉ‡∫´‡∫ç‡ªà‡∫¢‡∫π‡ªà‡∫ï‡ªà‡∫≤‡∫á‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î';
                evaluationEl.classList.add('text-blue-400', 'animate-pulse');
                memeContent = `
                    <div class="flex items-center justify-center h-full bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div class="text-center">
                            <div class="text-6xl sm:text-8xl mb-2 sm:mb-4">ü§î</div>
                            <p class="text-lg sm:text-2xl text-white font-bold">LAO ABROAD</p>
                            <p class="text-sm sm:text-lg text-gray-200">${accuracyRounded}% - Half way there!</p>
                            <div class="mt-2 text-3xl sm:text-4xl">‚úàÔ∏èüåè</div>
                        </div>
                    </div>
                `;
            } else if (accuracy >= 20) {
                // 20-39%: At least not "Jing Jai"
                evaluation = '‡∫¢‡ªà‡∫≤‡∫á‡ªú‡ªâ‡∫≠‡∫ç‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡∫Å‡ªç‡∫ö‡ªç‡ªà‡ªÅ‡∫°‡ªà‡∫ô‡∫Ñ‡∫ª‡∫ô "‡∫à‡∫£‡∫¥‡∫á‡ªÉ‡∫à"';
                evaluationEl.classList.add('text-yellow-500', 'animate-pulse');
                memeContent = `
                    <div class="flex items-center justify-center h-full bg-gradient-to-br from-yellow-600 to-orange-700 p-4">
                        <div class="text-center">
                            <div class="text-6xl sm:text-8xl mb-2 sm:mb-4">üòè</div>
                            <p class="text-lg sm:text-2xl text-white font-bold">NOT "JING JAI"</p>
                            <p class="text-sm sm:text-lg text-gray-200">${accuracyRounded}% - Could be worse!</p>
                        </div>
                    </div>
                `;
            } else {
                // 0-19%: Foreigner whose plane crashed
                evaluation = '‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡ªÄ‡∫õ‡∫±‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫ï‡ªà‡∫≤‡∫á‡∫õ‡∫∞‡ªÄ‡∫ó‡∫î ‡∫ó‡∫µ‡ªà‡∫ï‡∫ª‡∫Å‡∫ç‡∫ª‡∫ô';
                evaluationEl.classList.add('text-red-500', 'animate-shake');
                memeContent = `
                    <div class="flex items-center justify-center h-full bg-gradient-to-br from-gray-800 to-red-900 p-4">
                        <div class="text-center">
                            <div class="text-6xl sm:text-8xl mb-2 sm:mb-4">üò≠</div>
                            <p class="text-lg sm:text-2xl text-white font-bold">PLANE CRASH!</p>
                            <p class="text-sm sm:text-lg text-gray-300">${accuracyRounded}% - Foreigner detected!</p>
                            <div class="mt-2 text-4xl sm:text-5xl animate-bounce">‚úàÔ∏èüí•</div>
                        </div>
                    </div>
                `;
            }
            
            evaluationEl.textContent = evaluation;
            memeContainer.innerHTML = memeContent;
            
            // Save game stats
            saveGameStats();
            
            // Switch screens
            gameScreen.classList.remove('active');
            resultsScreen.classList.add('active');
        }

        // Save game stats
        function saveGameStats() {
            const stats = JSON.parse(localStorage.getItem('gameStats') || '{}');
            
            if (!stats.totalGames) stats.totalGames = 0;
            if (!stats.totalCorrect) stats.totalCorrect = 0;
            if (!stats.totalMistakes) stats.totalMistakes = 0;
            if (!stats.bestStreak) stats.bestStreak = 0;
            
            stats.totalGames++;
            stats.totalCorrect += correctAnswers;
            stats.totalMistakes += (totalAnswers - correctAnswers);
            stats.bestStreak = Math.max(stats.bestStreak, currentStreak);
            
            localStorage.setItem('gameStats', JSON.stringify(stats));
        }

        // Reset game
        function resetGame() {
            currentStreak = 0;
            currentWordIndex = 0;
            correctAnswers = 0;
            totalAnswers = 0;
            playerLives = 3;
            currentLevel = 0;
            levelProgress = 0;
            levelScores.easy = 0;
            levelScores.medium = 0;
            levelScores.hard = 0;
            gameActive = false;
            
            updateUI();
            updateLifeDisplay();
            updateLevelDisplay();
            updateDifficultyDisplay();
            
            gameScreen.classList.add('active');
            resultsScreen.classList.remove('active');
            
            showNewWords();
        }

        // Sound functions
        function initializeSounds() {
            if (typeof Tone !== 'undefined' && soundEnabled) {
                synth = new Tone.Synth().toDestination();
            }
        }

        function playSound(type) {
            if (!soundEnabled || !synth) return;
            
            try {
                if (type === 'correct') {
                    synth.triggerAttackRelease("C5", "8n");
                } else if (type === 'incorrect') {
                    synth.triggerAttackRelease("C3", "8n");
                } else if (type === 'timeout') {
                    synth.triggerAttackRelease("G3", "8n");
                }
            } catch (error) {
                console.error('Error playing sound:', error);
            }
        }

        // Event listeners
        function setupEventListeners() {
            // Card clicks
            wordCardLeft.addEventListener('click', () => {
                if (gameActive) {
                    checkAnswer(wordCardLeft.textContent);
                }
            });
            
            wordCardRight.addEventListener('click', () => {
                if (gameActive) {
                    checkAnswer(wordCardRight.textContent);
                }
            });
            
            // Keyboard controls
            document.addEventListener('keydown', (e) => {
                if (!gameActive || !isKeyboardEnabled) return;
                
                if (e.key.toLowerCase() === 'a') {
                    e.preventDefault();
                    wordCardLeft.classList.add('focused');
                    selectedLeftCard = true;
                    selectedRightCard = false;
                    wordCardRight.classList.remove('focused');
                    checkAnswer(wordCardLeft.textContent);
                } else if (e.key.toLowerCase() === 'd') {
                    e.preventDefault();
                    wordCardRight.classList.add('focused');
                    selectedRightCard = true;
                    selectedLeftCard = false;
                    wordCardLeft.classList.remove('focused');
                    checkAnswer(wordCardRight.textContent);
                }
            });
            
            // Button clicks
            restartGameBtn.addEventListener('click', resetGame);
            
            // Share image buttons
            setupShareButtons();
        }
        
        // Share Image Generator Functions
        function setupShareButtons() {
            const generateBtn = document.getElementById('generate-share-btn');
            const nativeShareBtn = document.getElementById('native-share-btn');
            const downloadBtn = document.getElementById('download-share-btn');
            const copyBtn = document.getElementById('copy-share-btn');
            const previewContainer = document.getElementById('share-preview-container');
            const previewImg = document.getElementById('share-preview');
            const copyStatus = document.getElementById('copy-status');
            const formatSquareBtn = document.getElementById('format-square');
            const formatLandscapeBtn = document.getElementById('format-landscape');
            
            let selectedFormat = 'square';
            let currentImageBlob = null;
            
            // Format switching
            formatSquareBtn.addEventListener('click', () => {
                selectedFormat = 'square';
                formatSquareBtn.classList.add('active');
                formatLandscapeBtn.classList.remove('active');
            });
            
            formatLandscapeBtn.addEventListener('click', () => {
                selectedFormat = 'landscape';
                formatLandscapeBtn.classList.add('active');
                formatSquareBtn.classList.remove('active');
            });
            
            generateBtn.addEventListener('click', async () => {
                // Ensure fonts are loaded before generating image
                await document.fonts.ready;
                
                const { dataUrl, blob } = await generateShareImage(selectedFormat);
                currentImageBlob = blob;
                previewImg.src = dataUrl;
                previewContainer.classList.remove('hidden');
                downloadBtn.classList.remove('hidden');
                
                // Show native share button if Web Share API is available
                if (navigator.share && navigator.canShare) {
                    // Check if sharing files is supported
                    const testFile = new File(['test'], 'test.txt', { type: 'text/plain' });
                    if (navigator.canShare({ files: [testFile] })) {
                        nativeShareBtn.classList.remove('hidden');
                    }
                }
                
                // Show copy button only if clipboard API is available
                if (navigator.clipboard && window.ClipboardItem) {
                    copyBtn.classList.remove('hidden');
                }
            });
            
            // Native share button
            nativeShareBtn.addEventListener('click', async () => {
                if (!currentImageBlob) return;
                
                try {
                    const file = new File([currentImageBlob], `lao-typo-score-${Date.now()}.png`, {
                        type: 'image/png'
                    });
                    
                    const shareData = {
                        title: 'LaoTypo - ‡∫ú‡∫ª‡∫ô‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫Ç‡∫≠‡∫á‡∫Ç‡ªâ‡∫≠‡∫ç',
                        text: `‡∫Ç‡ªâ‡∫≠‡∫ç‡∫´‡∫≤‡∫Å‡ªç‡ªà‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡ªÄ‡∫Å‡∫° LaoTypo ‡∫à‡∫ª‡∫ö! ${document.getElementById('evaluation-result').textContent}`,
                        files: [file]
                    };
                    
                    if (navigator.canShare(shareData)) {
                        await navigator.share(shareData);
                    } else {
                        // Fallback to sharing without file if file sharing is not supported
                        await navigator.share({
                            title: shareData.title,
                            text: shareData.text,
                            url: window.location.href
                        });
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Error sharing:', err);
                        // Fallback to download if share fails
                        downloadBtn.click();
                    }
                }
            });
            
            downloadBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                link.download = `lao-typo-score-${Date.now()}.png`;
                link.href = previewImg.src;
                link.click();
            });
            
            copyBtn.addEventListener('click', async () => {
                try {
                    if (currentImageBlob && navigator.clipboard && window.ClipboardItem) {
                        const item = new ClipboardItem({ 'image/png': currentImageBlob });
                        await navigator.clipboard.write([item]);
                        
                        copyStatus.classList.remove('hidden');
                        setTimeout(() => {
                            copyStatus.classList.add('hidden');
                        }, 3000);
                    }
                } catch (err) {
                    console.error('Failed to copy image:', err);
                    alert('‡∫ö‡ªç‡ªà‡∫™‡∫≤‡∫°‡∫≤‡∫î‡∫Ñ‡∫±‡∫î‡∫•‡∫≠‡∫Å‡∫Æ‡∫π‡∫ö‡ªÑ‡∫î‡ªâ. ‡∫Å‡∫∞‡∫•‡∫∏‡∫ô‡∫≤‡∫î‡∫≤‡∫ß‡ªÇ‡∫´‡∫•‡∫î‡ªÅ‡∫ó‡∫ô.');
                }
            });
        }
        
        async function generateShareImage(format = 'square') {
            // Ensure fonts are loaded
            await document.fonts.ready;
            
            const canvas = document.getElementById('share-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size based on format
            if (format === 'landscape') {
                canvas.width = 1200;
                canvas.height = 630;
            } else {
                canvas.width = 1080;
                canvas.height = 1080;
            }
            
            // Get game stats
            const finalScore = document.getElementById('final-streak').textContent;
            const bestScore = document.getElementById('results-best-streak').textContent;
            const accuracy = document.getElementById('accuracy-stat').textContent;
            const evaluation = document.getElementById('evaluation-result').textContent;
            
            // Create gradient background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#2c2e31');
            gradient.addColorStop(0.5, '#3e4043');
            gradient.addColorStop(1, '#2c2e31');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add decorative pattern
            ctx.strokeStyle = 'rgba(248, 175, 60, 0.1)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 20; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * 60);
                ctx.lineTo(canvas.width, i * 60);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(i * 60, 0);
                ctx.lineTo(i * 60, canvas.height);
                ctx.stroke();
            }
            
            // Layout adjustments based on format
            if (format === 'landscape') {
                // Landscape layout (1200x630)
                
                // Try to load and draw the Gecko mascot on the left
                try {
                    const geckoImg = new Image();
                    geckoImg.src = 'Gecko.png';
                    await new Promise((resolve, reject) => {
                        geckoImg.onload = resolve;
                        geckoImg.onerror = reject;
                        setTimeout(reject, 3000);
                    });
                    
                    const imgSize = 150;
                    ctx.drawImage(geckoImg, 50, (canvas.height - imgSize) / 2, imgSize, imgSize);
                } catch (error) {
                    ctx.font = 'bold 150px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#f8af3c';
                    ctx.fillText('ü¶é', 125, canvas.height / 2 + 50);
                }
                
                // Right side content
                const contentX = 280;
                
                // App title
                ctx.fillStyle = '#f8af3c';
                ctx.font = 'bold 42px "Montserrat", sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('LaoTypo', contentX, 80);
                
                // Subtitle
                ctx.fillStyle = '#d1d0c5';
                ctx.font = '24px "Noto Sans Lao Looped", sans-serif';
                ctx.fillText('‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡ªÅ‡∫°‡ªà‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫•‡∫≤‡∫ß‡∫à‡∫£‡∫¥‡∫á ‡∫´‡∫º‡∫∑ ‡∫•‡∫≤‡∫ß‡∫≠‡∫µ‡ªà‡∫´‡∫•‡∫µ?', contentX, 120);
                
                // "I just finished!" message
                ctx.fillStyle = '#72b483';
                ctx.font = 'bold 32px "Noto Sans Lao Looped", sans-serif';
                ctx.fillText('‡∫Ç‡ªâ‡∫≠‡∫ç‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫à‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß! üéâ', contentX, 180);
                
                // Stats
                ctx.fillStyle = '#f8af3c';
                ctx.font = 'bold 28px "Noto Sans Lao Looped", sans-serif';
                ctx.fillText('‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫Ç‡∫≠‡∫á‡∫Ç‡ªâ‡∫≠‡∫ç:', contentX, 240);
                
                ctx.fillStyle = '#d1d0c5';
                ctx.font = '24px "Noto Sans Lao Looped", sans-serif';
                ctx.fillText(`‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫•‡ªà‡∫≤‡∫™‡∫∏‡∫î: ${finalScore}`, contentX, 290);
                ctx.fillText(`‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫î‡∫µ‡∫ó‡∫µ‡ªà‡∫™‡∫∏‡∫î: ${bestScore}`, contentX, 330);
                ctx.fillText(`‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á: ${accuracy}`, contentX, 370);
                
                // Evaluation
                ctx.fillStyle = '#f8af3c';
                ctx.font = 'bold 22px "Noto Sans Lao Looped", sans-serif';
                const evalWords = evaluation.split(' ');
                let evalLine = '';
                let evalY = 440;
                const evalMaxWidth = 850;
                
                for (let n = 0; n < evalWords.length; n++) {
                    const testLine = evalLine + evalWords[n] + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > evalMaxWidth && n > 0) {
                        ctx.fillText(evalLine, contentX, evalY);
                        evalLine = evalWords[n] + ' ';
                        evalY += 35;
                    } else {
                        evalLine = testLine;
                    }
                }
                ctx.fillText(evalLine, contentX, evalY);
                
                // Website at bottom
                ctx.fillStyle = '#646669';
                ctx.font = '20px "Montserrat", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('laotypo.com', canvas.width / 2, canvas.height - 30);
                
            } else {
                // Square layout (1080x1080)
                
                // Try to load and draw the Gecko mascot
                try {
                    const geckoImg = new Image();
                    geckoImg.src = 'Gecko.png';
                    await new Promise((resolve, reject) => {
                        geckoImg.onload = resolve;
                        geckoImg.onerror = reject;
                        setTimeout(reject, 3000);
                    });
                    
                    const imgSize = 180;
                    ctx.drawImage(geckoImg, (canvas.width - imgSize) / 2, 80, imgSize, imgSize);
                } catch (error) {
                    ctx.font = 'bold 200px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#f8af3c';
                    ctx.fillText('ü¶é', canvas.width / 2, 250);
                }
                
                // Draw app title
                ctx.fillStyle = '#f8af3c';
                ctx.font = 'bold 48px "Montserrat", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('LaoTypo', canvas.width / 2, 350);
                
                // Draw subtitle
                ctx.fillStyle = '#d1d0c5';
                ctx.font = '32px "Noto Sans Lao Looped", sans-serif';
                ctx.fillText('‡ªÄ‡∫à‡∫ª‡ªâ‡∫≤‡ªÅ‡∫°‡ªà‡∫ô‡∫Ñ‡∫ª‡∫ô‡∫•‡∫≤‡∫ß‡∫à‡∫£‡∫¥‡∫á ‡∫´‡∫º‡∫∑ ‡∫•‡∫≤‡∫ß‡∫≠‡∫µ‡ªà‡∫´‡∫•‡∫µ?', canvas.width / 2, 400);
                
                // Draw "I just finished!" message
                ctx.fillStyle = '#72b483';
                ctx.font = 'bold 36px "Noto Sans Lao Looped", sans-serif';
                ctx.fillText('‡∫Ç‡ªâ‡∫≠‡∫ç‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫à‡∫ª‡∫ö‡ªÅ‡∫•‡ªâ‡∫ß! üéâ', canvas.width / 2, 480);
                
                // Draw stats container background
                ctx.fillStyle = 'rgba(100, 102, 105, 0.3)';
                ctx.fillRect(140, 520, 800, 300);
                
                // Draw stats
                ctx.fillStyle = '#f8af3c';
                ctx.font = 'bold 36px "Noto Sans Lao Looped", sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫Ç‡∫≠‡∫á‡∫Ç‡ªâ‡∫≠‡∫ç:', 180, 580);
                
                // Score details
                ctx.fillStyle = '#d1d0c5';
                ctx.font = '32px "Noto Sans Lao Looped", sans-serif';
                ctx.fillText(`‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫•‡ªà‡∫≤‡∫™‡∫∏‡∫î: ${finalScore}`, 180, 640);
                ctx.fillText(`‡∫Ñ‡∫∞‡ªÅ‡∫ô‡∫ô‡∫î‡∫µ‡∫ó‡∫µ‡ªà‡∫™‡∫∏‡∫î: ${bestScore}`, 180, 690);
                ctx.fillText(`‡∫Ñ‡∫ß‡∫≤‡∫°‡∫ñ‡∫∑‡∫Å‡∫ï‡ªâ‡∫≠‡∫á: ${accuracy}`, 180, 740);
                
                // Draw evaluation in a box
                ctx.fillStyle = 'rgba(248, 175, 60, 0.2)';
                ctx.fillRect(140, 840, 800, 120);
                
                ctx.fillStyle = '#f8af3c';
                ctx.font = 'bold 28px "Noto Sans Lao Looped", sans-serif';
                ctx.textAlign = 'center';
                
                // Word wrap for long evaluation text
                const maxWidth = 750;
                const lineHeight = 40;
                const words = evaluation.split(' ');
                let line = '';
                let y = 900;
                
                for (let n = 0; n < words.length; n++) {
                    const testLine = line + words[n] + ' ';
                    const metrics = ctx.measureText(testLine);
                    const testWidth = metrics.width;
                    if (testWidth > maxWidth && n > 0) {
                        ctx.fillText(line, canvas.width / 2, y);
                        line = words[n] + ' ';
                        y += lineHeight;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, canvas.width / 2, y);
                
                // Add website/app name at bottom
                ctx.fillStyle = '#646669';
                ctx.font = '24px "Montserrat", sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('laotypo.com', canvas.width / 2, 1040);
            }
            
            // Add decorative elements
            ctx.strokeStyle = '#f8af3c';
            ctx.lineWidth = 4;
            ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
            
            // Convert canvas to blob and data URL
            const dataUrl = canvas.toDataURL('image/png');
            
            // Create blob for native sharing
            const blob = await new Promise(resolve => {
                canvas.toBlob(blob => {
                    resolve(blob);
                }, 'image/png');
            });
            
            return { dataUrl, blob };
        }

        // Navigation handlers
        function setupNavigationHandlers() {
            // Home button navigation
            document.getElementById('home-btn').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = 'registration.html';
            });
            
            document.getElementById('home-nav-btn').addEventListener('click', () => {
                window.location.href = 'testing.html';
            });
            
            // Return home button in footer
            document.getElementById('return-home-btn').addEventListener('click', () => {
                window.location.href = 'testing.html';
            });
            
            // Other navigation buttons can be added here
            document.getElementById('leaderboard-nav-btn').addEventListener('click', () => {
                // Add leaderboard functionality
            });
            
            document.getElementById('open-settings-btn').addEventListener('click', () => {
                // Add settings functionality
            });
            
            document.getElementById('account-nav-btn').addEventListener('click', () => {
                // Add account functionality
            });
        }

        // Level Transition Modal Functions
        function showLevelTransitionModal() {
            const modal = document.getElementById('level-transition-modal');
            const levelMessage = document.getElementById('level-message');
            const levelQuestion = document.getElementById('level-question');
            const levelScore = document.getElementById('level-score');
            const levelIcon = document.getElementById('level-icon');
            const continueBtn = document.getElementById('continue-next-level');
            const replayBtn = document.getElementById('replay-current-level');
            
            // Pause the game
            gameActive = false;
            
            // Update modal content based on current level
            levelScore.textContent = levelProgress;
            
            if (currentLevel === 0) {
                // Completed Easy Level
                levelIcon.textContent = 'üü¢';
                levelMessage.textContent = '‡∫ó‡ªà‡∫≤‡∫ô‡∫ú‡ªà‡∫≤‡∫ô‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫á‡ªà‡∫≤‡∫ç‡ªÅ‡∫•‡ªâ‡∫ß!';
                levelQuestion.textContent = '‡∫™‡∫∑‡∫ö‡∫ï‡ªç‡ªà‡ªÑ‡∫õ‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á‡∫ö‡ªç?';
                continueBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ‡ªÅ‡∫°‡ªà‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß, ‡ªÑ‡∫õ‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á!
                `;
            } else if (currentLevel === 1) {
                // Completed Medium Level
                levelIcon.textContent = 'üîµ';
                levelMessage.textContent = '‡∫ó‡ªà‡∫≤‡∫ô‡∫ú‡ªà‡∫≤‡∫ô‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫õ‡∫≤‡∫ô‡∫Å‡∫≤‡∫á‡ªÅ‡∫•‡ªâ‡∫ß!';
                levelQuestion.textContent = '‡∫™‡∫∑‡∫ö‡∫ï‡ªç‡ªà‡ªÑ‡∫õ‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫ç‡∫≤‡∫Å‡∫ö‡ªç?';
                continueBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ‡ªÅ‡∫°‡ªà‡∫ô‡ªÅ‡∫•‡ªâ‡∫ß, ‡ªÑ‡∫õ‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫ç‡∫≤‡∫Å!
                `;
            } else if (currentLevel === 2) {
                // Completed Hard Level
                levelIcon.textContent = 'üî¥';
                levelMessage.textContent = '‡∫ó‡ªà‡∫≤‡∫ô‡∫ú‡ªà‡∫≤‡∫ô‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫ç‡∫≤‡∫Å‡ªÅ‡∫•‡ªâ‡∫ß! üèÜ';
                levelQuestion.textContent = '‡∫ó‡ªà‡∫≤‡∫ô‡∫ï‡ªâ‡∫≠‡∫á‡∫Å‡∫≤‡∫ô‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫ï‡ªç‡ªà ‡∫´‡∫º‡∫∑ ‡∫à‡∫ª‡∫ö‡ªÄ‡∫Å‡∫°?';
                continueBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ‡∫´‡∫º‡∫¥‡ªâ‡∫ô‡∫ï‡ªç‡ªà (‡∫•‡∫∞‡∫î‡∫±‡∫ö‡∫ç‡∫≤‡∫Å)
                `;
                replayBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    ‡∫Å‡∫±‡∫ö‡ªÑ‡∫õ‡ªú‡ªâ‡∫≤‡∫´‡∫º‡∫±‡∫Å
                `;
            }
            
            // Show the modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Play success sound
            playSound('correct');
        }
        
        function setupLevelTransitionHandlers() {
            const modal = document.getElementById('level-transition-modal');
            const continueBtn = document.getElementById('continue-next-level');
            const replayBtn = document.getElementById('replay-current-level');
            
            continueBtn.addEventListener('click', () => {
                if (currentLevel < 2) {
                    // Advance to next level
                    currentLevel++;
                    levelProgress = 0;
                    updateLevelDisplay();
                    updateDifficultyDisplay();
                    
                    // Hide modal and continue game
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // Resume game with new level
                    setTimeout(() => {
                        showNewWords();
                    }, 500);
                } else {
                    // At hard level, continue playing hard
                    levelProgress = 0;
                    updateLevelDisplay();
                    
                    // Hide modal and continue game
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // Resume game
                    setTimeout(() => {
                        showNewWords();
                    }, 500);
                }
            });
            
            replayBtn.addEventListener('click', () => {
                if (currentLevel === 2) {
                    // At hard level, "replay" means go to home
                    window.location.href = 'testing.html';
                } else {
                    // Replay current level
                    levelProgress = 0;
                    updateLevelDisplay();
                    
                    // Hide modal and continue game
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    
                    // Resume game at same level
                    setTimeout(() => {
                        showNewWords();
                    }, 500);
                }
            });
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeGame();
            setupLevelTransitionHandlers();
        });
    </script>
    
    <!-- Footer with Return Home button -->
    <footer class="fixed bottom-0 left-0 right-0 p-3 sm:p-4 bg-[#222426] border-t-2 border-[#f8af3c]">
        <div class="max-w-7xl mx-auto text-center">
            <button id="return-home-btn" class="btn btn-primary px-4 sm:px-6 py-1.5 sm:py-2 text-sm sm:text-base">
                ‡∫Å‡∫±‡∫ö‡ªÑ‡∫õ‡ªú‡ªâ‡∫≤‡∫´‡∫º‡∫±‡∫Å
            </button>
        </div>
    </footer>
</body>
</html>
